<%
# load the i2p account
i2p = BlackStack::FreeLeadsData::Account.where(:id=>@login.user.id_account).first

# price per record
i2p.update_price_per_record
ppr = i2p.price_per_record.to_f
dq = i2p.daily_quota
tq = i2p.today_quota

# get account balance
i2p.update_balance
amount = i2p.balance('leads').to_f

# dataset
a = BlackStack::MicroData::Zi::Search.where(:id_account=>@login.user.id_account, :delete_time=>nil)

# filter
# TODO: create re-utilizable functions for this.
filter = @login.user.preference("dashboard.q", '', params[:q].nil? ? nil : params[:q].to_s)
a = a.where(Sequel.lit("name ILIKE '%#{filter.to_sql}%'")) if !filter.to_s.empty?

# pagination
# `LIMIT #{page_size.to_s} OFFSET #{((page_number.to_i - 1) * page_size.to_i).to_s}`
# TODO: create re-utilizable functions for this.
page_size = 10
total_rows = a.count
if total_rows>0
  total_pages = (total_rows.to_f/page_size.to_f).ceil
  # if there is a GET parameters `number` on the URL, update the user preference regarding the page number on this screen
  # then, get user preferences regarding the page number on this screen
  page_number = @login.user.preference("dashboard.pagination.page", 1, params[:number].nil? ? nil : params[:number].to_i)
  # pagination correction to prevent glitches
  page_number = 1 if page_number < 1
  page_number = total_pages if page_number > total_pages
  # calculate info for showing at the bottom of the table
  from_row = (page_number.to_i-1) * page_size.to_i + 1
  to_row = [page_number*page_size, total_rows].min
else
  total_pages = 1
  page_number = 1
  from_row = 0
  to_row = 0
end
a = a.order(:name).limit(page_size, (page_number.to_i - 1) * page_size.to_i).all
%>

<!--
<section class='container'>
-->
    <!-- NavBar -->
    <div class="mynavbar mysticky">
        <div class="row-fluid">	
            <div class="span3">
                <%=nav1("Searches")%>
            </div>
            <div class="span9" style='text-align:right;'>
                <form action='/dashboard' method='get' id='search-form' name='search-form'>
                    <a href='/new' class='btn btn-blue'><i class="icon-plus"></i></a>
                    <button class='btn btn-blue' id='delete' name='delete' data-rows-group-id='searches'><i class="icon-trash"></i></button>
                    <button class='btn btn-green' id='play' name='play' data-rows-group-id='searches'><i class="icon-play"></i></button>
                    <button class='btn btn-black' id='pause' name='pause' data-rows-group-id='searches'><i class="icon-pause"></i></button>
                
                    <input class='input input-large' id='q' name='q' value='<%=filter.encode_html%>'></input>
                    <button class='btn btn-blue btn-submit' id='search'><i class="icon-search"></i></button>
                </form>
            </div>
        </div>
    </div>

    <%    
    progress_value = a.size == 0 ? 0.to_f.round(2).to_label : (a.map { |o| o.stat_progress.to_f }.sum.to_f * 100.to_f / a.size.to_f).round(2).to_label

    x = a.map { |o| o.stat_processed_results.to_i }.sum.to_f
    y = a.map { |o| o.stat_verified_results.to_i }.sum.to_f
    z = x <= 0 ? 0.to_f : (y*100.to_f) / x
    %>

    <div class='row-fluid box'>
        <div class='row-fluid'>
            <div class='span3'>
                <button class='btn btn-black btn-block btn-large' id='dfyl-verify' type='button' disabled>
                    <span style='font-size:32px;'>~<%=short_label(a.map { |o| o.stat_tier1_scope.to_i }.sum)%></span>
                    <br/>
                    <b>All Searches Scope <span title='Summary of the estmated scope of all searches that started running.'><i class='icon-question-sign'></i></span></b><br/>
                    <b>-</b>
                </button>
            </div>
            <div class='span3'>
                <button class='btn btn-blue btn-block btn-large' id='dfyl-verify' type='button' disabled>
                    <span style='font-size:32px;'><%=progress_value%>%</span>
                    <br/>
                    <b>Average Progress <span title='Average progress of all searches that started running.'><i class='icon-question-sign'></i></span></b><br/>
                    <b>-</b>
                </button>
            </div>
            <div class='span3'>
                <button class='btn btn-orange btn-block btn-large' id='dfyl-verify' type='button' disabled>
                    <span style='font-size:32px;'><%=short_label(a.map { |o| o.stat_processed_results.to_i }.sum)%></span>
                    <br/>
                    <b>Processed Records</b><br/>
                    <b><%=progress_value%>%</b>
                </button>
            </div>
            <div class='span3'>
                <button class='btn btn-green btn-block btn-large' id='dfyl-verify' type='button' disabled>
                    <span style='font-size:32px;'><%=short_label(a.map { |o| o.stat_verified_results.to_i }.sum)%></span>
                    <br/>
                    <b>Matching LookUps</b><br/>
                    <b><%=z.round(4).to_label%>%</b>
                </button>
            </div>
        </div>
    </div>

    <div class='row-fluid box'>
        <div class='row-fluid'>
            <div class='span9'>
                <span id='page-info'>
                    <span style='color:gray;font-size:14px;'>
                        Showing <b><%=from_row.to_label%></b> to <b><%=to_row.to_label%></b> of <b><%=total_rows.to_label%></b> records
                    </span>
                    <%
                    if !filter.to_s.empty?
                    %>
                    <span style='color:wite;font-size:14px;width:50px;text-align:center;'>
                        |
                    </span>
                    <span style='color:gray;font-size:14px;'>
                        <b>Filter: </b> <span class='label label-blue'><%=filter.encode_html%> <a href='/dashboard?q=' style='color:white;'><i class='icon-remove'></i></a></span>
                    </span>
                    <%
                    end # if !filter.to_s.empty?
                    %>
                </span>

                <input type='hidden' id='ids' name='ids' value='' />
                <table class='table table-strip-condensed'>
                    <thead>
                        <tr>
                            <th width='8px' style='width:8px;text-align:center;'>
                                <input type='checkbox' class='checkbox select-all-rows' data-input-id='ids' data-rows-group-id='searches' />
                            </th>
                            <th width='auto'>Search</th>
                            <th width='24px' style='text-align:center;'>Status</th>
                            <th width='48px' style='text-align:right;'>Scope</th>
                            <th width='48px' style='text-align:right;'>Progress</th>
                            <th width='48px' style='text-align:right;'>Processed</th>
                            <th width='48px' style='text-align:right;'>LookUps</th>
                            <th width='8px' style='text-align:center;'><!-- download --></th>
                            <th width='48px' style='text-align:right;'>Forecast</th>
                            <th width='48px' style='text-align:right;'><!-- play / pause --></th>
                        </tr>
                    </thead>
                    <tbody>
                        <%
                        i = 0
                        a.each { |s|
                            i += 1
                            h = s.to_hash(true)
                            %>
                            <tr>
                                <td>
                                    <input type='checkbox' class="checkbox select-row" data-rows-group-id='searches' id='<%=s.id%>' data-id='<%=s.id%>' />
                                </td>
                                <td>
                                    <a target='_window' href='/edit/<%=h['id']%>'>
                                        <%
                                        if filter.to_s.empty?
                                        %>
                                        <%=s.name.encode_html%>
                                        <%
                                        # TODO: create re-utilizable functions for this highlighting.
                                        else #if filter.to_s.empty?
                                            x = s.name.encode_html
                                            a = x.scan(/#{filter}/i)
                                            a.each { |m|
                                                x = x.gsub(m, "<span style='background-color:yellow;'>#{m}</span>")
                                            }
                                        %>
                                        <%=x%>
                                        <%
                                        end #if filter.to_s.empty?
                                        %>
                                    </a>
                                </td>

                                <td>
                                    <span class='badge badge-<%=h['report']['badge_color']%>'><%=h['report']['badge_text']%></span>
                                </td>
                                
                                <td style='text-align:right;'><%=h['report']['scope']%></td>

                                <td style='text-align:right;'>
                                    <%=h['report']['progress']%><br/>
                                    <span style='color:gray;font-size:10px;'>-</span> 
                                </td>
                                
                                <td style='text-align:right;'>
                                    <%=h['report']['processed']%><br/>
                                    <span style='color:gray;font-size:10px;'><%=h['report']['processed_rate']%></span> 
                                </td>
                                
                                <td style='text-align:right;'>
                                    <%=h['report']['verified']%><br/>
                                    <span style='color:gray;font-size:10px;'><%=h['report']['verified_rate']%></span> 
                                </td>

                                <td style='text-align:center;'>
                                    <%
                                    if !h['export']['export_download_url'].to_s.empty?
                                    %>
                                    <a target='_window' href='<%=h['export']['export_download_url']%>'><i class='icon-cloud-download'></i></a>
                                    <%
                                    end
                                    %>
                                </td>
                                
                                <td style='text-align:right;'>
                                    <%=h['report']['forecast_text']%><br/>
                                    <span style='color:gray;font-size:10px;'>records</span> 
                                </td>

                                <td style='text-align:right;'>
                                    <div class="btn-group">
                                        <a class="btn dropdown-toggle" data-toggle="dropdown" href="#">
	                                        Actions
	                                        <span class="caret"></span>
                                        </a>
                                        <ul class="dropdown-menu">
                                            <li>
                                                <a href='/edit/<%=s.id%>'>Edit <i class='icon-pencil'></i></a>
                                            </li>

                                            <li>
                                                <a href='/filter_copy?id=<%=s.id%>'>Copy <i class='icon-copy'></i></a>
                                            </li>

                                            <li>
                                                <a href='/filter_delete?ids=<%=s.id%>'>Delete <i class='icon-trash'></i></a>
                                            </li>

                                            <li>
                                                <%
                                                if s.off?
                                                %>
                                                <a href='/filter_play?ids=<%=s.id%>'>Play <i class='icon-play'></i></a>
                                                <%
                                                else # if s.on?
                                                %>
                                                <a href='/filter_pause?ids=<%=s.id%>'>Pause <i class='icon-pause'></i></a>
                                                <%
                                                end # if s.on?
                                                %>
                                            </li>
                                        </ul>
                                    </div>
                                </td>
                                
                            </tr>
                            <%
                        }
                        if i == 0
                        %>
                            <tr>
                                <td colspan='20' style='text-align:center;'>
                                    <br/>
                                    <h1>No Searches Found.</h1>
                                    <a href='/new' class='btn btn-blue btn-large'>Create It</a>
                                </td>
                            </tr>
                        <%
                        end
                        %>
                    </tbody>
                </table> 
                
                <div class="pagination"></div>
                <script>
                    drawPagination($(".pagination"), <%=page_number%>, <%=total_pages%>);
                </script>            
            </div>

            <div class='span3'>
                <section class='row-fluid'>
                    <div class='span12 box'>
                        <center><h4>Balance</h4></center>
                        <%
                        if amount.to_f > 0
                        %>
                        <center><h3 style='color:green;'>$<%=amount.to_f.round(4)%></h3></center>
                        <%
                        elsif amount.to_f == 0.to_f
                        %>
                        <center><h3 style='color:red;'>$<%=amount.to_f.round(4)%></h3></center>
                        <%
                        else # if amount.to_f > 0
                        %>
                        <center><h3 style='color:red;'>-$<%=(-amount).to_f.round(4)%></h3></center>
                        <%
                        end # if amount.to_f > 0
                        %>
                        <center><a class='btn btn-small btn-blue' href='/plans'><b>upgrade</b></a></center>
                    </div>
                </section>

                <section class='row-fluid'>
                    <div class='span12 box'>
                        <center><h4>LookUp Fee</h4></center>
                        <center><h3 style='color:blue;'><%=(100.to_f*ppr.to_f).round(4)%> <span style='font-size:16px;'> &cent;</span></h3></center>
                    </div>
                </section>

                <section class='row-fluid'>
                    <div class='span12 box'>
                        <center><h4>Daily Quota</h4></center>
                        <center><h3 style='color:green;'><%=dq.to_label%></h3></center>
                        <center><span style='color:gray;font-size:16px;'>lookups / day</span></center>
                    </div>
                </section>

                <section class='row-fluid'>
                    <div class='span12 box'>
                        <center><h4>Today Usage</h4></center>
                        <%
                        rate = dq.to_f == 0.to_f ? 0.to_f.round(2) : (100.to_f*(tq.to_f/dq.to_f)).round(2)
                        if tq < dq 
                        %>
                        <center><h3 style='color:green;'><%=rate.to_label%>%</h3></center>
                        <%
                        else # if amount.to_f > 0
                        %>
                        <center><h3 style='color:red;'><%=rate.to_label%>%</h3></center>
                        <%
                        end # if amount.to_f > 0
                        %>
                        <center><span style='color:gray;font-size:16px;'><%=tq.to_label%> / <%=dq.to_label%> lookups</span></center>
                    </div>
                </section>
            </div>
        </div>
    </div>
    
    <%
    BlackStack::Pampa.jobs.each { |j|
    %>
    <div class='row-fluid box'>
        <div class='row-fluid'>
            <div class='span12'>
                <h2><%=j.name.encode_html%></h2>
            </div>
        </div>
        <div class='row-fluid'>
            <div class='span3'>
                <button class='btn btn-black btn-block btn-large' id='dfyl-verify' type='button' disabled>
                    <span style='font-size:32px;'><%=j.total.to_label%></span>
                    <br/>
                    <b>total</b>
                </button>
            </div>
            <div class='span3'>
                <button class='btn btn-blue btn-block btn-large' id='dfyl-verify' type='button' disabled>
                    <span style='font-size:32px;'><%=j.completed.to_label%></span>
                    <br/>
                    <b>completed</b>
                </button>
            </div>
            <div class='span3'>
                <button class='btn btn-green btn-block btn-large' id='dfyl-verify' type='button' disabled>
                    <span style='font-size:32px;'><%=j.pending.to_label%></span>
                    <br/>
                    <b>pending</b>
                </button>
            </div>
            <div class='span3'>
                <button class='btn btn-red btn-block btn-large' id='dfyl-verify' type='button' disabled>
                    <span style='font-size:32px;'><%=j.failed.to_label%></span>
                    <br/>
                    <b>failed</b>
                </button>
            </div>
        </div>
    </div>
    <%
    }
    %>    
<!--
</section>
-->

<script>
    $(document).ready(function() {
        // something
        console.log('Hello!');

        // click on #delete button
        $('#delete').click(function() {
            // get the value of #ids input
            var ids = $('#ids').val();
            // redirect to /filter_delete?ids=...
            window.location.href = '/filter_delete?ids=' + ids;
        });

        // click on #play button
        $('#play').click(function() {
            // get the value of #ids input
            var ids = $('#ids').val();
            // redirect to /filter_play?ids=...
            window.location.href = '/filter_play?ids=' + ids;
        });

        // click on #pause button
        $('#pause').click(function() {
            // get the value of #ids input
            var ids = $('#ids').val();
            // redirect to /filter_pause?ids=...
            window.location.href = '/filter_pause?ids=' + ids;
        });

        // submit #search-form when press ENTER on #q input
        $('#q').keypress(function(e) {
            if(e.which == 13) {
                $('#search-form').submit();
            }
        });

        // select all text in #q when click on it or set focus on it
        $('#q').click(function() {
            $(this).select();
        }).focus(function() {
            $(this).select();
        });
    });

    // call the function init when the page is loaded.
    selectRowsJs.init();
</script>